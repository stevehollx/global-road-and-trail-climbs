name: Index Release Assets

on:
  release:
    types: [published, edited]
  pull_request:
    types: [closed]
    paths:
      - 'releases/*.md'
      - 'north-america/**/README.md'
      - 'south-america/**/README.md'
      - 'europe/**/README.md'
      - 'asia/**/README.md'
      - 'africa/**/README.md'
      - 'oceania/**/README.md'
  push:
    branches:
      - main
    paths:
      - 'releases/*.md'
      - 'north-america/**/README.md'
      - 'south-america/**/README.md'
      - 'europe/**/README.md'
      - 'asia/**/README.md'
      - 'africa/**/README.md'
      - 'oceania/**/README.md'
  workflow_dispatch:

jobs:
  # Job 1: Publish draft release when PR is merged
  publish-release:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract release tag from merged files
        id: extract_tag
        run: |
          # Get the changed files in the PR - check both releases folder and geographic folders
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path' | grep -E '(^releases/.*\.md$|README\.md$)' | head -1)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No release markdown file found"
            exit 1
          fi

          echo "Found changed file: $CHANGED_FILES"

          # Read the markdown file to get the release tag
          # Handles both old format "Release Tag:** `tag`" and new format "* Release Tag: `tag`"
          RELEASE_TAG=$(grep -oP '(?:Release Tag:\*\* `|\* Release Tag: `)\K[^`]+' "$CHANGED_FILES" || echo "")

          if [ -z "$RELEASE_TAG" ]; then
            echo "Could not extract release tag from $CHANGED_FILES"
            exit 1
          fi

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Found release tag: $RELEASE_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish draft release
        run: |
          # Get the draft release by tag
          RELEASE_DATA=$(gh release view "${{ steps.extract_tag.outputs.release_tag }}" --json id,isDraft 2>/dev/null || echo "")

          if [ -z "$RELEASE_DATA" ]; then
            echo "Release not found: ${{ steps.extract_tag.outputs.release_tag }}"
            exit 1
          fi

          IS_DRAFT=$(echo "$RELEASE_DATA" | jq -r '.isDraft')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "Publishing draft release..."
            gh release edit "${{ steps.extract_tag.outputs.release_tag }}" --draft=false
            echo "Release published successfully"
          else
            echo "Release is already published"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Update index.json when release is published
  index-releases:
    runs-on: ubuntu-latest
    needs: [publish-release]
    # Run if: release event, push event, workflow_dispatch, OR PR merge succeeded
    if: |
      always() && (
        github.event_name == 'release' ||
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && needs.publish-release.result == 'success')
      )

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run indexer
        run: python scripts/index_xlsx_files.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}

      - name: Check if index.json was modified
        id: check_changes
        run: |
          git diff --name-only | grep -q "index.json" && echo "changed=true" >> $GITHUB_OUTPUT || echo "changed=false" >> $GITHUB_OUTPUT

      - name: Commit and push index.json
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add index.json
          git commit -m "Update index.json with release assets [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
